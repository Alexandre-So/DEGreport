<!--
%\VignetteEngine{knitr}
%\VignetteIndexEntry{DEGReport}
-->

```{r}
library(rjags)
library(DEGreport)
data(humanSexDEedgeR)

library(edgeR)
```
Do differential expression with edgeR
```{r}
plotBCV(humanSexDEedgeR)
```


GLM DE analysis
```{r}
des<-humanSexDEedgeR$design
fit <- glmFit(humanSexDEedgeR,des)
lrt <- glmLRT(fit)
tab<-cbind(lrt$table,p.adjust(lrt$table$PValue,method="BH"))
detags <- rownames(tab[tab[,5]<=0.1,])
plotSmear(humanSexDEedgeR, de.tags=detags)
```

Distribution of FC
```{r}
table(cut(tab[detags,"logFC"],breaks=c(-100,-0.5,0.5,100),labels=c(-1,0,1)))
```

Check pvalue distribution
```{r}
counts<-cpm(humanSexDEedgeR,log=FALSE)
g1<-colnames(counts)[1:41]
g2<-colnames(counts)[42:85]
design<-data.frame(condition=sub("1","Male",sub("0","Female",des[,2])))

```

```{r}

library(biomaRt)
mart = useMart("ensembl", dataset="hsapiens_gene_ensembl")
g = getGene( id = detags, type = "ensembl_gene_id", mart = mart)
colors=data.frame(genes=g$ensembl_gene_id,colors=sub("[1-9]{1,2}","Autosomic",g$chromosome_name))

#just a quick analysis
detag10<-detags[1:10]
createReport(g1,g2,counts,detag10,tab[,4],tab[detag10,1],"~/crickhome/temp/",colors,pop=400)

degObj(counts,design,"~/crickhome/temp/degObj.rda")
library(shiny)
runGist(9930881)

degMean(tab[,4],counts)
detagsm<-detags[1:10]
degRank(g1,g2,counts[detagsm,],tab[detagsm,1],400)

```


Random M vs F
```{r}
idxr<-as.numeric(sample(row.names(design),10))
countsr=humanSexDEedgeR$counts[,idxr]
names(countsr)<-colnames(countsr)
designr<-design[idxr,,drop=FALSE]
row.names(designr)<-colnames(countsr)
g1r<-row.names(designr[designr[,1]=="Female",,drop=FALSE])
g2r<-row.names(designr[designr[,1]!="Female",,drop=FALSE])


Dr <- DGEList(counts=humanSexDEedgeR$counts[,idxr],group=design[idxr,])
Dr <- calcNormFactors(Dr)
desr <- model.matrix(~design[idxr,])
Dr <- estimateGLMCommonDisp(Dr, desr)
Dr <- estimateGLMTrendedDisp(Dr, desr)
Dr <- estimateGLMTagwiseDisp(Dr, desr)
fitr <- glmFit(Dr,desr)
lrtr <- glmLRT(fitr)
tabr<-cbind(lrtr$table,p.adjust(lrtr$table$PValue,method="BH"))
detagsr <- rownames(tabr[tabr[,5]<=0.1,])

#just a quick analysis
detag10<-detagsr[1:10]
createReport(g1r,g2r,countsr,detag10,tabr[,4],tabr[detag10,1],"~/crickhome/temp/",pop=400,name="random")

degObj(countsr,designr,"~/crickhome/temp/degObjRandom.rda")

library(shiny)
runGist(9930881)

```


