```{r}
data(humanSexDEedgeR)
library(edgeR)
```
Do differential expression with edgeR
```{r}
plotBCV(humanSexDEedgeR)
```


GLM DE analysis
```{r}
des<-humanSexDEedgeR$design
fit <- glmFit(humanSexDEedgeR,des)
lrt <- glmLRT(fit)
tab<-cbind(lrt$table,p.adjust(lrt$table$PValue,method="BH"))
detags <- rownames(tab[tab[,5]<=0.1,])
plotSmear(humanSexDEedgeR, de.tags=detags)
```

Distribution of FC
```{r}
table(cut(tab[detags,"logFC"],breaks=c(-100,-0.5,0.5,100),labels=c(-1,0,1)))
```

Check pvalue distribution
```{r}
counts<-cpm(humanSexDEedgeR,log=FALSE)
g1<-colnames(counts)[1:41]
g2<-colnames(counts)[42:85]
```

```{r}
library(DEGreport)
library(devtools)
devtools::load_all()
degMean(tab[,4],counts)
detagsm<-detags[1:10]
degRank(g1,g2,counts[detagsm,],tab[detagsm,1],400)
createReport(g1,g2,counts,detagsm,tab[,4],tab[detagsm,1],"~/crickhome/temp/",pop=400)
design<-data.frame(condition=sub("1","Male",sub("0","Female",des[,2])))
degObj(counts,design,"~/crickhome/temp/degObj.rda")

  library(biomaRt)
  mart = useMart("ensembl", dataset="hsapiens_gene_ensembl")
  g = getGene( id = detags, type = "ensembl_gene_id", mart = mart)

 
```


Random M vs F
```{r}
idxr<-sample(row.names(design),10)
Dr <- DGEList(counts=countsf[,idxr],group=design[idxr,2])
Dr <- calcNormFactors(Dr)
desr <- model.matrix(~design[idxr,2])
Dr <- estimateGLMCommonDisp(Dr, desr)
Dr <- estimateGLMTrendedDisp(Dr, desr)
Dr <- estimateGLMTagwiseDisp(Dr, desr)
fitr <- glmFit(Dr,desr)
lrtr <- glmLRT(fitr)
tabr<-cbind(lrtr$table,p.adjust(lrtr$table$PValue,method="BH"))
detagsr <- rownames(tabr[tabr[,5]<=0.1,])

genderr<-design[idxr,2]
names(genderr)<-idxr
popfcr<-get_ratio(names(genderr[genderr=="Male"]),names(genderr[genderr!="Male"]),counts[detagsr,idxr])
e.tabr<-get_estimate(log2(popfcr))
e.tab.tr<-as.data.frame(t(e.tabr))
maxvr<-apply(e.tab.tr[,3:4],1,function(x){
  idxm<-which.min(abs(x))
  return(x[idxm])
})
e.tab.tr$log2<-(unlist(maxvr))
head(e.tab.tr[order(abs(e.tab.tr$log2),decreasing=F),],20)

detabr<-tab[detagsr,]
head(detabr[order(detabr$logFC,decreasing=T),])

mixr<-cbind(e.tab.tr[detagsr,3:6],detabr[detagsr,"logFC"])
mixr$dif<- -1*mixr[,4]/mixr[,5]
head(mixr[order(abs(mixr$dif),decreasing=F),])
head(mixr[order(abs(mixr[,4]),decreasing=T),])
head(mixr[order(abs(mixr[,5]),decreasing=T),])
```


Check pvalue distribution
```{r}
for (g in detagsr){
 exp<-data.frame(counts=as.numeric(unlist(counts[g,idxr])),gender=design[idxr,2])
 p<-ggplot(exp,aes(gender,counts,colour=gender))+  
    geom_jitter()+
    theme_bw()
 pdf(paste0("img/",g,".pdf"))
 print(p)
 dev.off()
}
```
