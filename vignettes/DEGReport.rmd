<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{DEGReport}
-->

```{r}
library(DEGreport)
data(humanSexDEedgeR)

library(edgeR)
```

Get the path to write the report
```{r}
if (Sys.info()["sysname"]=="Windows"){pathreport<-paste0(getwd(),'\\')}
if (Sys.info()["sysname"]!="Windows"){pathreport<-paste0(getwd(),'/')}
```


GLM DE analysis, humanSexDEedgeR and edgeR object, so we need just to run the glm function to get DE genes.

```{r}
des<-humanSexDEedgeR$design
fit <- glmFit(humanSexDEedgeR,des)
lrt <- glmLRT(fit)
tab<-cbind(lrt$table,p.adjust(lrt$table$PValue,method="BH"))
detags <- rownames(tab[tab[,5]<=0.1,])
plotSmear(humanSexDEedgeR, de.tags=detags)
```


Create the design data.frame where the condition can be Male or Female.

```{r}
counts<-cpm(humanSexDEedgeR,log=FALSE)
g1<-colnames(counts)[1:41]
g2<-colnames(counts)[42:85]
design<-data.frame(condition=sub("1","Male",sub("0","Female",des[,2])))

```


We are getting the chromosome information for each gene.

```{r}
library(biomaRt)
mart = useMart("ensembl", dataset="hsapiens_gene_ensembl")
g = getGene( id = detags, type = "ensembl_gene_id", mart = mart)
colors=data.frame(genes=g$ensembl_gene_id,colors=sub("[1-9]{1,2}","Autosomic",g$chromosome_name))

#just a quick analysis
detag10<-detags[1:10]
createReport(g1,g2,counts,detag10,tab[,4],tab[detag10,1],pathreport,colors,pop=400)

##Run this if you want to visualize your expression values by condition
#degObj(counts,design,"~/crickhome/temp/degObj.rda")
#library(shiny)
#runGist(9930881)

#degMean(tab[,4],counts)
#detagsm<-detags[1:10]
#degRank(g1,g2,counts[detagsm,],tab[detagsm,1],400)

```


Generate same analyziz but with only 10 samples to get a bigger list.

```{r}
idxr<-as.numeric(sample(row.names(design),10))
countsr=humanSexDEedgeR$counts[,idxr]
names(countsr)<-colnames(countsr)
designr<-design[idxr,,drop=FALSE]
row.names(designr)<-colnames(countsr)
g1r<-row.names(designr[designr[,1]=="Female",,drop=FALSE])
g2r<-row.names(designr[designr[,1]!="Female",,drop=FALSE])


Dr <- DGEList(counts=humanSexDEedgeR$counts[,idxr],group=design[idxr,])
Dr <- calcNormFactors(Dr)
desr <- model.matrix(~design[idxr,])
Dr <- estimateGLMCommonDisp(Dr, desr)
Dr <- estimateGLMTrendedDisp(Dr, desr)
Dr <- estimateGLMTagwiseDisp(Dr, desr)
fitr <- glmFit(Dr,desr)
lrtr <- glmLRT(fitr)
tabr<-cbind(lrtr$table,p.adjust(lrtr$table$PValue,method="BH"))
detagsr <- rownames(tabr[tabr[,5]<=0.1,])

#just a quick analysis
detag10<-detagsr[1:10]
createReport(g1r,g2r,countsr,detag10,tabr[,4],tabr[detag10,1],pathreport,pop=400,name="random")

##Run this if you want to visualize your expression values by condition
#degObj(countsr,designr,"~/crickhome/temp/degObjRandom.rda")
#library(shiny)
#runGist(9930881)

```


